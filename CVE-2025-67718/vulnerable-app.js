/**
 * CVE-2025-67718 - Vulnerable Application
 * 
 * This application demonstrates the vulnerability in Form.io (≤ 3.5.6, ≤ 4.4.2)
 * where an attacker can bypass authorization checks by crafting specially 
 * encoded request paths.
 * 
 * Vulnerability: The middleware checks permissions on the raw, un-normalized path,
 * but Express router normalizes the path before routing. This creates a gap
 * where URL-encoded or path traversal techniques can bypass authorization.
 */

const express = require('express');
const bodyParser = require('body-parser');
const cors = require('cors');
const path = require('path');
const http = require('http');

const app = express();
const PORT = 3000;

// Middleware
app.use(cors());
app.use(bodyParser.json());
app.use(express.static('public'));

// CRITICAL: Store raw URLs in a WeakMap keyed by the request object itself
// This ensures we can retrieve the raw URL in Express middleware
const rawUrlStore = new WeakMap();

const httpServer = http.createServer((rawReq, rawRes) => {
  // Store the RAW URL (with %2f encoding intact) BEFORE Express processes it
  // Using WeakMap with the request object as key ensures we can retrieve it later
  rawUrlStore.set(rawReq, rawReq.url);
  
  // Pass to Express - Express will decode the URL but we have the original stored
  app(rawReq, rawRes);
});

// Middleware to attach raw URL to Express req object
// This MUST be the FIRST middleware to run
app.use((req, res, next) => {
  // Retrieve the ORIGINAL raw URL that was stored before Express decoded it
  // rawReq.url contains %2f, req.url is already decoded by Express to /
  req.rawEncodedUrl = rawUrlStore.get(req) || req.url;
  next();
});

// Simulated user database
const users = {
  'user1': {
    id: 1,
    username: 'user1',
    email: 'user1@example.com',
    role: 'user',
    token: 'user-token-12345'
  },
  'admin': {
    id: 2,
    username: 'admin',
    email: 'admin@example.com',
    role: 'admin',
    token: 'admin-token-67890'
  }
};

// Sensitive admin data
const adminData = {
  users: [
    { 
      id: 1, 
      username: 'admin', 
      email: 'admin@example.com',
      password: 'Admin@2025!SecurePass', 
      role: 'admin',
      apiKey: 'AKIA1234567890ABCDEF',
      lastLogin: '2025-12-11T10:30:00Z'
    },
    { 
      id: 2, 
      username: 'user1', 
      email: 'user1@example.com',
      password: 'User123!Pass', 
      role: 'user',
      apiKey: 'AKIA0987654321FEDCBA',
      lastLogin: '2025-12-11T09:15:00Z'
    },
    { 
      id: 3, 
      username: 'user2', 
      email: 'user2@example.com',
      password: 'User456!SecPass', 
      role: 'user',
      apiKey: 'AKIA1122334455AABBCC',
      lastLogin: '2025-12-10T16:45:00Z'
    }
  ],
  config: {
    databaseUrl: 'postgresql://admin:DbP@ssw0rd2025!@localhost:5432/formio_db',
    secretKey: 'super-secret-formio-key-2025-do-not-share',
    awsAccessKey: 'AKIAIOSFODNN7EXAMPLE',
    awsSecretKey: 'wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY',
    smtpPassword: 'smtp_P@ssw0rd_2025!'
  },
  settings: {
    allowRegistration: false,
    enableTwoFactor: true,
    sessionTimeout: 3600,
    maxLoginAttempts: 5,
    debugMode: false,
    maintenanceMode: false
  }
};

// Regular user data
const userData = {
  message: 'Welcome to the public API',
  version: '1.0.0',
  status: 'operational'
};

// Request logger
app.use((req, res, next) => {
  const timestamp = new Date().toISOString();
  const rawUrl = (req.rawEncodedUrl || req.url).split('?')[0];
  
  console.log(`[${timestamp}] ${req.method} ${req.path}`);
  console.log(`  Raw Encoded URL: ${rawUrl}`);
  console.log(`  Decoded Path: ${req.path}`);
  console.log(`  Headers:`, JSON.stringify(req.headers, null, 2));
  next();
});

/**
 * VULNERABLE MIDDLEWARE - Simulates Form.io authorization check
 * 
 * This middleware attempts to protect admin routes by checking the path,
 * but it has CRITICAL flaws in path validation and normalization.
 * 
 * VULNERABILITY: The middleware does simple string matching without proper
 * path normalization. It can be bypassed using:
 * 1. Path traversal: /api/./admin/users, /api/foo/../admin/users
 * 2. Trailing slashes: /api/admin//users
 * 3. Redundant slashes: /api//admin/users
 * 
 * Attack flow:
 * 1. Client sends: GET /api/./admin/users
 * 2. Middleware checks: "/api/./admin/users"
 * 3. Check result: Does NOT start with "/api/admin/" → BYPASS!
 * 4. Express normalizes and routes to: /api/admin/users
 * 5. Result: Protected endpoint accessed without authentication!
 */
function vulnerableAuthorizationMiddleware(req, res, next) {
  // BUG #1: Using req.path which may contain non-normalized path elements
  const pathToCheck = req.path;
  
  console.log(`[AUTH CHECK] Checking path: "${pathToCheck}"`);
  
  // BUG #2: Simple string matching without path normalization
  // Doesn't handle: /./, /../, //, trailing slashes, etc.
  if (pathToCheck.startsWith('/api/admin/')) {
    console.log(`[AUTH CHECK] ⚠️ Protected admin path detected`);
    
    // Check for admin token
    const adminToken = req.headers['x-admin-token'];
    
    if (!adminToken) {
      console.log(`[AUTH CHECK] ❌ No admin token provided - FORBIDDEN`);
      return res.status(403).json({ 
        error: 'Forbidden',
        message: 'Admin access required. Missing X-Admin-Token header.'
      });
    }
    
    if (adminToken !== 'secret-admin-token-2025') {
      console.log(`[AUTH CHECK] ❌ Invalid admin token - FORBIDDEN`);
      return res.status(403).json({ 
        error: 'Forbidden',
        message: 'Invalid admin token.'
      });
    }
    
    console.log(`[AUTH CHECK] ✓ Valid admin token - ACCESS GRANTED`);
  } else {
    console.log(`[AUTH CHECK] ✓ Path doesn't match '/api/admin/' - BYPASSING CHECK`);
    
    // Check if this is actually an admin path after normalization
    const normalized = pathToCheck
      .replace(/\/\.\//g, '/')  // Remove /./
      .replace(/\/[^/]+\/\.\.\//g, '/')  // Remove /../
      .replace(/\/+/g, '/');  // Collapse multiple slashes
    
    if (normalized.startsWith('/api/admin/')) {
      console.log(`[AUTH CHECK] ⚠️⚠️⚠️ VULNERABILITY EXPLOITED!`);
      console.log(`[AUTH CHECK] ⚠️⚠️⚠️ Original path: "${pathToCheck}"`);
      console.log(`[AUTH CHECK] ⚠️⚠️⚠️ Normalized: "${normalized}"`);
      console.log(`[AUTH CHECK] ⚠️⚠️⚠️ Authorization bypassed!`);
    }
  }
  
  next();
}

// Apply the vulnerable middleware
app.use(vulnerableAuthorizationMiddleware);

/**
 * Public Routes
 */

// Health check
app.get('/health', (req, res) => {
  res.json({ 
    status: 'healthy',
    timestamp: new Date().toISOString(),
    version: '1.0.0'
  });
});

// Public API
app.get('/api/public/info', (req, res) => {
  res.json(userData);
});

// Login endpoint
app.post('/api/login', (req, res) => {
  const { username, password } = req.body;
  
  const user = users[username];
  if (!user) {
    return res.status(401).json({ error: 'Invalid credentials' });
  }
  
  // In real app, check password hash
  // For demo, we'll just return the token
  res.json({
    token: user.token,
    user: {
      id: user.id,
      username: user.username,
      email: user.email,
      role: user.role
    }
  });
});

/**
 * PROTECTED ADMIN ROUTES
 * 
 * These routes should only be accessible with valid admin token.
 * However, due to the vulnerability, they can be accessed by crafting
 * the URL path to bypass the authorization check.
 * 
 * Note: Express normalizes paths during routing, so /api//admin/users,
 * /api/./admin/users, etc. will all route to /api/admin/users
 */

// Create a handler function that will be reused
function adminUsersHandler(req, res) {
  console.log(`[ADMIN ENDPOINT] Admin users endpoint accessed`);
  console.log(`[ADMIN ENDPOINT] ⚠️ Returning sensitive user data!`);
  console.log(`[ADMIN ENDPOINT] Original URL: ${req.originalUrl}`);
  console.log(`[ADMIN ENDPOINT] Path: ${req.path}`);
  
  res.json({
    success: true,
    endpoint: req.path,
    originalUrl: req.originalUrl,
    note: 'This endpoint should be protected!',
    data: adminData.users
  });
}

function adminConfigHandler(req, res) {
  console.log(`[ADMIN ENDPOINT] Admin config endpoint accessed`);
  console.log(`[ADMIN ENDPOINT] ⚠️ Returning sensitive configuration!`);
  console.log(`[ADMIN ENDPOINT] Original URL: ${req.originalUrl}`);
  
  res.json({
    success: true,
    endpoint: req.path,
    originalUrl: req.originalUrl,
    note: 'This endpoint should be protected!',
    data: adminData.config
  });
}

function adminSettingsHandler(req, res) {
  console.log(`[ADMIN ENDPOINT] Admin settings endpoint accessed`);
  console.log(`[ADMIN ENDPOINT] ⚠️ Returning sensitive settings!`);
  console.log(`[ADMIN ENDPOINT] Original URL: ${req.originalUrl}`);
  
  res.json({
    success: true,
    endpoint: req.path,
    originalUrl: req.originalUrl,
    note: 'This endpoint should be protected!',
    data: adminData.settings
  });
}

function adminExportHandler(req, res) {
  console.log(`[ADMIN ENDPOINT] Admin export endpoint accessed`);
  console.log(`[ADMIN ENDPOINT] ⚠️ CRITICAL: Full data export requested!`);
  console.log(`[ADMIN ENDPOINT] Original URL: ${req.originalUrl}`);
  
  res.json({
    success: true,
    endpoint: req.path,
    originalUrl: req.originalUrl,
    note: 'This endpoint should be protected!',
    exportedAt: new Date().toISOString(),
    data: {
      users: adminData.users,
      config: adminData.config,
      settings: adminData.settings
    }
  });
}

// Register routes - Express will normalize paths during routing
// So /api//admin/users, /api/./admin/users will all match /api/admin/users
app.get('/api/admin/users', adminUsersHandler);
app.get('/api/./admin/users', adminUsersHandler);
app.get('/api//admin/users', adminUsersHandler);
app.get('/api/foo/../admin/users', adminUsersHandler);

app.get('/api/admin/config', adminConfigHandler);
app.get('/api/./admin/config', adminConfigHandler);
app.get('/api//admin/config', adminConfigHandler);
app.get('/api/foo/../admin/config', adminConfigHandler);

app.get('/api/admin/settings', adminSettingsHandler);
app.get('/api/./admin/settings', adminSettingsHandler);
app.get('/api//admin/settings', adminSettingsHandler);
app.get('/api/foo/../admin/settings', adminSettingsHandler);

app.get('/api/admin/export', adminExportHandler);
app.get('/api/./admin/export', adminExportHandler);
app.get('/api//admin/export', adminExportHandler);
app.get('/api/foo/../admin/export', adminExportHandler);

// Update user (admin only)
app.put('/api/admin/users/:id', (req, res) => {
  console.log(`[ADMIN ENDPOINT] /api/admin/users/${req.params.id} accessed`);
  console.log(`[ADMIN ENDPOINT] ⚠️ User update requested!`);
  
  res.json({
    success: true,
    endpoint: `/api/admin/users/${req.params.id}`,
    note: 'This endpoint should be protected!',
    message: 'User updated successfully',
    data: req.body
  });
});

// Delete user (admin only)
app.delete('/api/admin/users/:id', (req, res) => {
  console.log(`[ADMIN ENDPOINT] /api/admin/users/${req.params.id} DELETE accessed`);
  console.log(`[ADMIN ENDPOINT] ⚠️ CRITICAL: User deletion requested!`);
  
  res.json({
    success: true,
    endpoint: `/api/admin/users/${req.params.id}`,
    note: 'This endpoint should be protected!',
    message: 'User deleted successfully',
    userId: req.params.id
  });
});

/**
 * Test endpoint to demonstrate the vulnerability
 */
app.get('/api/test/path-info', (req, res) => {
  res.json({
    message: 'Path information for debugging',
    rawUrl: req.url,
    path: req.path,
    originalUrl: req.originalUrl,
    baseUrl: req.baseUrl,
    decodedPath: decodeURIComponent(req.path),
    note: 'Notice how Express normalizes encoded characters in the path'
  });
});

/**
 * Info endpoint about the vulnerability
 */
app.get('/api/vulnerability-info', (req, res) => {
  res.json({
    cve: 'CVE-2025-67718',
    title: 'Unauthorized Permission Elevation Through Specially Crafted Request Path',
    severity: 'CRITICAL',
    description: 'A flaw in path handling allows attackers to bypass authorization by using URL-encoded paths',
    affectedVersions: {
      'formio': '<= 3.5.6, <= 4.4.2',
      'formio-server': '< 8.5.8, < 9.4.2'
    },
    patchedVersions: {
      'formio': '>= 3.5.7, >= 4.4.3',
      'formio-server': '>= 8.5.8, >= 9.4.3'
    },
    exploitMethods: [
      'URL Encoding: /api/admin%2fusers',
      'Double Encoding: /api/admin%252fusers',
      'Path Traversal: /api/admin/../admin/users',
      'Backslash: /api/admin\\users (Windows)',
      'Mixed case: /Api/Admin/users (if case-sensitive)'
    ],
    impact: [
      'Unauthorized access to protected endpoints',
      'Sensitive data exposure',
      'Privilege escalation',
      'Potential data manipulation'
    ]
  });
});

// 404 handler
app.use((req, res) => {
  res.status(404).json({ 
    error: 'Not Found',
    path: req.path
  });
});

// Error handler
app.use((err, req, res, next) => {
  console.error('[ERROR]', err);
  res.status(500).json({ 
    error: 'Internal Server Error',
    message: err.message
  });
});

// Start server using our custom HTTP server wrapper
httpServer.listen(PORT, () => {
  console.log('');
  console.log('═══════════════════════════════════════════════════════════════');
  console.log('  CVE-2025-67718 - Vulnerable Application');
  console.log('  Form.io Path Authorization Bypass POC');
  console.log('═══════════════════════════════════════════════════════════════');
  console.log('');
  console.log(`  Server running at: http://localhost:${PORT}`);
  console.log(`  Web Demo: http://localhost:${PORT}`);
  console.log('');
  console.log('  ⚠️  VULNERABLE VERSION - FOR TESTING ONLY!');
  console.log('  ⚠️  Uses custom HTTP server to capture raw URLs');
  console.log('');
  console.log('  Protected Admin Endpoints:');
  console.log('    GET  /api/admin/users      - List all users');
  console.log('    GET  /api/admin/config     - System configuration');
  console.log('    GET  /api/admin/settings   - System settings');
  console.log('    GET  /api/admin/export     - Export all data');
  console.log('');
  console.log('  Exploit Examples:');
  console.log('    curl http://localhost:3000/api/./admin/users');
  console.log('    curl http://localhost:3000/api//admin/config');
  console.log('    curl http://localhost:3000/api/foo/../admin/settings');
  console.log('');
  console.log('  How it works:');
  console.log('    1. Client sends: /api/./admin/users');
  console.log('    2. Middleware checks: path doesn\'t match "/api/admin/"');
  console.log('    3. Middleware: BYPASS (no auth check)');
  console.log('    4. Express normalizes: /. → removed, routes to /api/admin/users');
  console.log('    5. Result: Protected data exposed!');
  console.log('');
  console.log('  Required Admin Token: secret-admin-token-2025');
  console.log('  Header: X-Admin-Token');
  console.log('');
  console.log('═══════════════════════════════════════════════════════════════');
  console.log('');
});

module.exports = { app, httpServer };
